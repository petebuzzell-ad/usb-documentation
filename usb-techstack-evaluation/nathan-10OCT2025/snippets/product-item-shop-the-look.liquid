{% assign product = all_products[product_handle] %}

{% liquid
  assign promo_text = ''
  assign promo_messages = settings.promo_messages | newline_to_br | split: '<br />'
  for tag in product.tags
    if tag contains 'promo:'
      for message in promo_messages
        if message contains tag
          assign promo_text = message | remove: tag | remove: '||'
        endif
      endfor
    endif
  endfor
  if promo_text == blank
    if product.metafields["global"]["promo_text"] != blank
      assign promo_text = product.metafields["global"]["promo_text"]
    endif
  endif
%}

{% if variant_id != blank %}
  {% assign variant_id = variant_id | plus: 0 %}
  {% assign variant_array = product.variants | where: 'id', variant_id %}
  {% assign current_variant = variant_array[0] %}
  
  {%- assign featured_image = nil -%}
  {%- assign second_image = nil -%}
  {%- assign men_image = nil -%}
  {%- assign women_image = nil -%}
  {%- assign men_hover_image = nil -%}
  {%- assign women_hover_image = nil -%}
  {%- for image in product.images -%}
    {%- if image.alt contains 'hover_image' -%}
      {%- if image.alt contains color_alt -%}
        {%- if second_image != blank -%}
          {%- if gender_alt != blank and image.alt contains gender_alt -%}
            {%- assign second_image = image -%}
          {%- endif -%}  
        {%- else -%}
          {%- assign second_image = image -%}
        {%- endif -%}

        {%- if men_hover_image == blank and image.alt contains 'gender:men' -%}
          {%- assign men_hover_image = image -%}
        {%- endif -%}
        {%- if women_hover_image == blank and image.alt contains 'gender:women' -%}
          {%- assign women_hover_image = image -%}
        {%- endif -%}
      {%- endif -%}
    {% else %}
      {%- if image.alt contains color_alt -%}
        {%- if featured_image != blank -%}
          {%- if gender_alt != blank and image.alt contains gender_alt -%}
            {%- assign featured_image = image -%}
          {%- endif -%}  
        {%- else -%}
          {%- assign featured_image = image -%}
        {%- endif -%}

        {%- if men_image == blank and image.alt contains 'gender:men' -%}
          {%- assign men_image = image -%}
        {%- endif -%}
        {%- if women_image == blank and image.alt contains 'gender:women' -%}
          {%- assign women_image = image -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if featured_image == blank -%}
    {%- assign featured_image = variant.image | default: product.featured_image -%}
  {%- endif -%}
  {%- if second_image == blank -%}
    {%- assign second_image = featured_image -%}
  {%- endif -%}

  {%- if current_variant.price < current_variant.compare_at_price -%}
    {%- assign sale = true -%}
  {%- else -%}
    {%- assign sale = false -%}
  {%- endif -%}

  <div tabindex="0" class="product-item lg:w-full" {% unless mobile %} onclick="eHS.quickshop.openQuickshop(event,'{{ product.handle }}','{{ current_variant.id }}')"{% endunless %}>
    <a href="{{ current_variant.url | default: product.url | within: collection }}" class="product-item__image xs:mb-4 md:mb-2">
      <div class="product-item__image-wrapper">
        <img class="lazy product-item__primary-image" data-src="{{featured_image | img_url: '600x'}}" alt="{{featured_image.alt}}-primary"
          data-gendered="{{gendered}}" {% if men_image != nil %}data-men-img="{{men_image | img_url: '600x'}}"{% endif %} {% if women_image != nil %}data-women-img="{{women_image | img_url: '600x'}}"{% endif %}
          >
        <img class="lazy product-item__secondary-image" data-src="{{second_image | img_url: '600x'}}" alt="{{second_image.alt}}-secondary"
          data-gendered="{{gendered}}" {% if men_hover_image != nil %}data-men-img="{{men_hover_image | img_url: '600x'}}"{% endif %} {% if women_hover_image != nil %}data-women-img="{{women_hover_image | img_url: '600x'}}"{% endif %}
          >
      </div>
    </a>
    <div class="product-item__info md:mb-4">
      <a href="{{ current_variant.url | default: product.url | within: collection }}" class="product-item__title block font-normal text-p-xs">{{ product.title }}<span> - {{value}}</span></a>
      <div class="product-item__price">
        <span class="flex items-center justify-start">
          <span {% if sale %}class="text-red"{% endif %}>{{ current_variant.price | default: product.price | money }}</span>
          {%- if sale -%}
            <span class="text-[#585858] text-p-s text-right line-through inline-block ml-2.5 sm:ml-0 lg:ml-2.5">{{ current_variant.compare_at_price | money }}</span>
          {%- endif -%}
        </span>
      </div>
      {%- if promo_text -%}
        <span class="text-p-xs font-light text-red tracking-normal font-sora">{{ promo_text }}</span>
      {%- endif -%}
    </div>
  </div>
{% else %}
  {%- assign featured_image = product.featured_image -%}
  {%- assign second_image = nil -%}
  {%- assign men_image = nil -%}
  {%- assign women_image = nil -%}
  {%- assign men_hover_image = nil -%}
  {%- assign women_hover_image = nil -%}
  {%- for image in product.images -%}
    {%- if image.alt contains 'hover_image' -%}
      {%- if second_image != blank -%}
        {%- if gender_alt != blank and image.alt contains gender_alt -%}
          {%- assign second_image = image -%}
        {%- endif -%}  
      {%- else -%}
        {%- assign second_image = image -%}
      {%- endif -%}

      {%- if men_hover_image == blank and image.alt contains 'gender:men' -%}
        {%- assign men_hover_image = image -%}
      {%- endif -%}
      {%- if women_hover_image == blank and image.alt contains 'gender:women' -%}
        {%- assign women_hover_image = image -%}
      {%- endif -%}
    {% else %}
      {%- if gender_alt != blank and image.alt contains gender_alt -%}
        {%- assign featured_image = image -%}
      {%- endif -%}

      {%- if men_image == blank and image.alt contains 'gender:men' -%}
        {%- assign men_image = image -%}
      {%- endif -%}
      {%- if women_image == blank and image.alt contains 'gender:women' -%}
        {%- assign women_image = image -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if second_image == blank -%}
    {%- assign second_image = featured_image -%}
  {%- endif -%}

  {%- if product.price < product.compare_at_price -%}
    {%- assign sale = true -%}
  {%- else -%}
    {%- assign sale = false -%}
  {%- endif -%}

  <div tabindex="0" onclick="eHS.quickshop.openQuickshop(event,'{{ product.handle }}','{{ current_variant.id }}')">
    <a href="{{ product.url | within: collection }}" class="product-item__image xs:mb-4 md:mb-2">
      <div class="product-item__image-wrapper">
        <img class="lazy product-item__primary-image" data-src="{{featured_image | img_url: '600x'}}" alt="{{featured_image.alt}}-primary"
          data-gendered="{{gendered}}" {% if men_image != nil %}data-men-img="{{men_image | img_url: '600x'}}"{% endif %} {% if women_image != nil %}data-women-img="{{women_image | img_url: '600x'}}"{% endif %}
          >
        <img class="lazy product-item__secondary-image" data-src="{{second_image | img_url: '600x'}}" alt="{{second_image.alt}}-secondary"
          data-gendered="{{gendered}}" {% if men_hover_image != nil %}data-men-img="{{men_hover_image | img_url: '600x'}}"{% endif %} {% if women_hover_image != nil %}data-women-img="{{women_hover_image | img_url: '600x'}}"{% endif %}
          >
      </div>
    </a>
    <div class="product-item__info md:mb-4">
      <a href="{{ product.url | within: collection }}" class="product-item__title block font-normal text-p-xs">{{- product.title -}}</a>
      <div class="product-item__price">
        <span class="flex items-center justify-start">
          <span {% if sale %}class="text-red"{% endif %}>{{ product.price | money }}</span>
          {%- if sale -%}
            <span class="text-[#585858] text-p-s text-right line-through inline-block ml-2.5 sm:ml-0 lg:ml-2.5">{{ product.compare_at_price | money }}</span>
          {%- endif -%}
        </span>
      </div>
      {%- if promo_text -%}
        <span class="text-p-xs font-light text-red tracking-normal font-sora">{{ promo_text }}</span>
      {%- endif -%}
    </div>
  </div>
{% endif %}