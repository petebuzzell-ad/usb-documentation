<script>
  (function($) {
    $(document).on('ready page:load page:change', function() {
      var regex = /\b(?:p\.?\s*o\.?|post\s+office)(\s+)?(?:box|[0-9]*)?\b/ig;
      var fieldErrorClass = 'field--error';
      var fieldErrorMessageSelector = '.field__message--error';
      var errorText = "{{ 'plus.PO_error_message' | t }}";
      var $inputs = $("[data-step] [name='checkout[shipping_address][address1]'], [data-step] [name='checkout[shipping_address][address2]']");
      
      // regex check
      var regexCheckFn = function(elem) {
        var $current = $(elem);
        var $parent = $current.closest('.field__input-wrapper');
        var $field = $current.closest('.field');
        if (regex.test($current.val())) {
          if (!$field.hasClass(fieldErrorClass)) {
            $field.addClass(fieldErrorClass);
          }
          if ($field.find(fieldErrorMessageSelector).length < 1) {
            $parent.after("<p class='field__message field__message--error'>"+ errorText +"</p>");
          }
          return false;
        } else {
          if ($field.hasClass(fieldErrorClass)) {
            $field.removeClass(fieldErrorClass);
          }
          if ($field.find(fieldErrorMessageSelector).length > 0) {
            $field.find(fieldErrorMessageSelector).remove();
          }
          return true;
        }
      };

      // Call regex check on form submit
      $(document).on('submit', '[data-step] form', function() {
        // default to true and will be set to false if there is an error to prevent form submission
        var isValid = true;
        $inputs.each(function() {
          isValid = isValid && regexCheckFn($(this));
        });
        return isValid;
      });

      // Call regex check on blur
      const submitButton = document.getElementById("continue_button")
      $inputs.blur(function() {
        const inputsValid = regexCheckFn($(this));
        if(!inputsValid) {
          submitButton.disabled = true;
          submitButton.classList.add("btn--disabled");
        } else {
          submitButton.disabled = false;
          submitButton.classList.remove("btn--disabled");
        }
      });

    });
    }
  )(Checkout.$);
</script>
