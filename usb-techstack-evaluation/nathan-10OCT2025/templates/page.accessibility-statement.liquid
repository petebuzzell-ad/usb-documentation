{% render 'shogun-products', content: page %}
<div class="article">
  <div class="container cf">
    <div class="page-header cf">
      <h1 class="majortitle">{{ page.title }}</h1>
    </div>
    <div class="user-content">
      {{ page.content }}
    </div>
  </div>
</div>

{% if handle == 'search-results' %}

{% if settings.product_promoted_ids %}
  
    {% assign promoted_ids = settings.product_promoted_ids | split: ',' %}
    {% for promotedId in promoted_ids %}
      <style>
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] {
        border: 0 !important;
      }
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] .isp_product_info,
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] .isp_sold_out_banner_container {
        display: none;
      }
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] .isp_product_image_wrapper {
        height: 100% !important;
        background: none !important;
      }
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] .isp_product_image_wrapper a {
        font-size: 0;
      }
      ul#isp_search_results_container li.isp_grid_product[product_id="{{ promotedId }}"] .isp_product_image_wrapper img {
        position: relative;
        top: 0;
        left: 0;
        transform: none;
        height: auto;
        max-height: 100%;
        padding: 0;
      }
      </style>
    {% endfor %}
{% endif %}
<script>
var loadedProducts = {
  {%- paginate collections.all.products by 1000 -%}
  {%- for product in collections['all'].products -%}
    "{{product.handle}}": {
      image: "{{product.featured_image | img_url: '60x65', crop: 'center', scale: 2 }}",
      {% for media in product.media -%}
        {%- if media.alt contains '!!MAIN!!' -%}
          {%- if media.media_type == "image" %}
          image_main: "{{ media | img_url: '300x400', crop: 'center', scale: 2 }}",
          {%- else %}
          image_main: `{{ media | video_tag: image_size: '300x400', controls: false, muted: true, loop: true, autoplay: true }}`,
          {%- endif %}        
        image_main_switch: "{{media.preview_image | img_url: '60x65', crop: 'center', scale: 2 }}",
        {%- endif %}
      {%- endfor -%}
      price: "{{product.price}}",
      compare_at_price: "{{product.compare_at_price}}"{% if product.compare_at_price >0 %},
      percentage: "{{ product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price }}"{%endif %}
    }{%- unless forloop.last == "true"-%},{%- endunless-%}
  {%- endfor -%}
  {%- endpaginate -%}
}
</script>

<script>

function insertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}

function getAdditionalInfo(ISPlusProductId) {
  var productTargeted = $("#isp_search_results_container .isp_grid_product[product_id='"+ISPlusProductId+"']");
  var handleWithoutVariant = productTargeted.find('.isp_product_image_href').attr('href').split('?');
  var handle = handleWithoutVariant[0].split('/');
  handle = handle[handle.length-1].replace('?ref=isp_rel_no_match','');

  var promoted_ids = "{{ settings.product_promoted_ids }}"; 

  if(loadedProducts[handle] && loadedProducts[handle]["compare_at_price"]) {
    productTargeted.addClass("has-discount");
    productTargeted.find('.isp_product_image_wrapper').append('<span class="discount_percentage">'+parseInt(loadedProducts[handle]["percentage"])+'% OFF</span>');
  } 

  $.ajax({
    type: 'GET',
    url: '/products/' + handle + '?view=metafields.json',
    success: function(response) {
      metafieldsJSON = JSON.parse(response);

      if(loadedProducts[handle[handle.length-1]].image_main && !productTargeted.find(".isp_product_image_main").length) {
        productTargeted.find(".isp_product_image_wrapper").addClass('has_main_image');
        if(!loadedProducts[handle[handle.length-1]].image_main.includes('video')) {
          productTargeted.find(".isp_product_image").attr('src',loadedProducts[handle[handle.length-1]].image_main)
          productTargeted.find(".isp_product_image_wrapper a").append(`<img alt="`+productTargeted.find(".isp_product_image").attr('alt')+`" src="`+loadedProducts[handle[handle.length-1]].image_main+`" class="isp_product_image_main">`);
      
        } else {
          productTargeted.find(".isp_product_image_wrapper").addClass('has_video');
          productTargeted.find(".isp_product_image_wrapper a").append(loadedProducts[handle[handle.length-1]].image_main);
        }
      }
      
      if(promoted_ids.includes(productTargeted.attr('product_id'))) {
        if(metafieldsJSON != undefined && metafieldsJSON.global != undefined && metafieldsJSON.global.violator_url != undefined) {
          productTargeted.find(".isp_product_image_href").attr('href',metafieldsJSON.global.violator_url);
          productTargeted.addClass('no-swatches');
        }
      } else {
        if(metafieldsJSON != undefined && metafieldsJSON.colorop != undefined && metafieldsJSON.colorop.ordering != undefined) {
          swatches = JSON.parse(metafieldsJSON.colorop.ordering);
          if(!productTargeted.find('.isp_product_swatches_switch').length) {
            var switches = `<div class="isp_product_swatches_switch">`;
            $.each(swatches, function(i, ordering) {
              if(i<4) { 
                if(loadedProducts[ordering.handle]) {
                  if(loadedProducts[ordering.handle].image_main_switch) switches += `<a href="/products/`+ordering.handle+`" style="background-image: url(`+loadedProducts[ordering.handle].image_main_switch+`)"></a>`;
                  else switches += `<a href="/products/`+ordering.handle+`" style="background-image: url(`+loadedProducts[ordering.handle].image+`)"></a>`;
                }
              } else {
                switches += `<a href="/products/`+handle+`" class="plus-more">+`+(swatches.length - 4)+`</a>`;
                return false;
              }
            });
            switches += `</div>`;
            productTargeted.find(".isp_product_info").before(switches);
          }
        }
        if(metafieldsJSON != undefined && metafieldsJSON.colorop != undefined && metafieldsJSON.colorop.ordering_count != undefined && parseInt(metafieldsJSON.colorop.ordering_count) > 0) {
          if(!productTargeted.find('.isp_product_swatches').length) productTargeted.find(".isp_product_info").append('<div class="isp_product_swatches">'+metafieldsJSON.colorop.ordering_count+' colors</div>');
        } else {
          productTargeted.addClass('no-swatches');
        }
      }
    },
    error: function(status) {
    }
  });
}

var updateProductsInterval = setInterval( function() {
  if($("#isp_search_results_container li:not(.no-swatches):not(:has(.isp_product_swatches))").length > 0) {
    $.each($("#isp_search_results_container li:not(.no-swatches):not(:has(.isp_product_swatches))"), function(i, val) {
      if($(this).attr('position') && !$(this).find('.isp_product_swatches').length) $(this).find('.isp_product_info').append(getAdditionalInfo($(this).attr('product_id')));        
    });
  } else {
    clearInterval(updateProductsInterval);
  }
}, 1000);

var ispSearchResultText = setInterval(function() {
  if($('#isp_results_summary #isp_results_search_text').length) {
    clearInterval(ispSearchResultText);
    if($('#isp_results_search_text').length) {
      $('.page-header h1').html('SEARCH RESULTS FOR "<span>'+$('#isp_results_summary #isp_results_search_text').text()+'</span>"');
      if($("#isp_results_summary > b").length) {
        $('.page-header h2.no-results').remove();
        $('.page-header h1').after("<h2 class='no-results'>No results for <b>"+$("#isp_results_summary > b").text()+"</b></h2>");
      }
    } else {
      var url_string = window.location.href;
      var url = new URL(url_string);
      var q = url.searchParams.get("q");
      if(q) {
        $('.page-header h1').html('SEARCH RESULTS FOR "<span>'+q+'</span>"');
      }
    }
  } 
}, 500);


// Select the node that will be observed for mutations
var targetNode = document.getElementById('isp_results_summary');
// Options for the observer (which mutations to observe)
var config = { attributes: true, childList: true, subtree: true };
// Callback function to execute when mutations are observed
var callback = function (mutationsList, observer) {
  for (var mutation of mutationsList) {
      if($('#isp_results_search_text').lenth) {
        if($('#isp_results_summary #isp_results_search_text').text() != $('.page-header h1 span').text()) {
          $('.page-header h1').html('SEARCH RESULTS FOR "<span>'+$('#isp_results_summary #isp_results_search_text').text()+'</span>"');
        }
        if($('.page-header h2.no-results').text() != $("#isp_results_summary").text()){
          if($("#isp_results_summary > b").length) {
            $('.page-header h2.no-results').remove();
            $('.page-header h1').after("<h2 class='no-results'>No results for <b>"+$("#isp_results_summary > b").text()+"</b></h2>");
          } else {
            $('.page-header h2.no-results').remove();
          }
        }
      } else {
        var url_string = window.location.href;
        var url = new URL(url_string);
        var q = url.searchParams.get("q");
        if(q) {
          $('.page-header h1').html('SEARCH RESULTS FOR "<span>'+q+'</span>"');
        }
      }
  }
};
// Create an observer instance linked to the callback function
var observer = new MutationObserver(callback);

// Start observing the target node for configured mutations
if (targetNode != undefined) {
  observer.observe(targetNode, config);
} else {
  var isTargetNode = setInterval(function () {
    if (targetNode != undefined) {
      clearInterval(isTargetNode);
      observer.observe(targetNode, config);
    }
  }, 500);
}

</script>
{% endif %}
