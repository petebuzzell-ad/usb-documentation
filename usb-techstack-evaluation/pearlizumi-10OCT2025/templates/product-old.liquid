{%- comment -%}

Dearest future eHouse developer,

I want to apologize for the complexity that you will find as you peel back the layers of this project.

The requirements shifted beneath our feet, and we had to make compromises or quick decisions to adjust.
The client also had multiple competing priorities, some of which required us to make concessions or remove entire
pieces of functionality that were built for the launch.

Please don't hold this code against only me personally - it's the product of multiple failures.

I have some ideas in mind for refactoring this code, the most important of which is probably creating
an ES6 class to encompass the Buy Box. Currently, we are forced to update Buy Box code on the PDP and the Quickview separately.
In an ideal world, that would be one class which gets extended for the Quickview portion, so the logic/pricing/etc. can be managed in one place.

God speed, and good luck with all of this.

Sincerely,
Cam

{%- endcomment -%}
{% liquid
  if shop.permanent_domain == 'pearlizumi.myshopify.com'
    assign storefront = "US"
  elsif shop.permanent_domain == 'pearlizumi-ca.myshopify.com'
    assign storefront = "CA"
  elsif shop.permanent_domain == 'pearl-izumi-int.myshopify.com'
    assign storefront = "INT"
  endif

  if storefront == "US"
    assign yotpo_widget_id = "60e4d1ec437b2b7164666bb1"
  elsif storefront == "CA"
    assign yotpo_widget_id = "615e12d54c7ceb2e0eec6a0f"
  elsif storefront == "INT"
    assign yotpo_widget_id = "615e13716f89925adc56a3f2"
  endif

  if customer
    assign discount_tag = false
    assign limit_tag = false
    for tag in customer.tags
      if tag contains "discount-"
        assign discount_tag = tag | remove: "discount-" | plus: 0
      endif
      if tag contains "limit-"
        assign limit_tag = tag | remove: "limit-" | plus: 0
      endif
    endfor
  endif

  assign is_pro = false
  if discount_tag and limit_tag
    assign is_pro = true
  endif
%}

<div class="px-6 md:px-14 xl:px-22.5 max-w-[124.5rem] mx-auto my-4 md:my-8">
  {% render 'breadcrumbs' template: template, product: product %}
</div>
<div id="productTemplate" class="transition-opacity opacity-0"
  data-product-handle="{{ product.handle }}"
  data-product-type="onetime"
  {% if product.tags contains 'gift-for-good' %}data-gift-product="true"{% endif %}
>
  <h1 class="hidden">{{ product.title }}</h1>

  <!-- Above The Fold Container -->
  <div class="w-full md:px-14 xl:px-22.5 xl:mb-14 max-w-[124.5rem] mx-auto">
    <!-- Mobile Buy Box Info -->
    <div class="md:hidden">
      {% render 'product-buy-box-info', mobile: true, product: product, quickview: quickview, storefront: storefront %}
    </div>

    <!-- Gallery & Buy Box -->
    <div class="flex w-full flex-col md:flex-row md:gap-6">
      <div class="w-full md:w-2/3 md:max-w-product-gallery-desktop">
        {% render 'product-gallery', product: product, quickview: quickview, storefront: storefront %}

        <!-- Feature Section (Desktop) -->
        <div class="hidden md:block md:pl-25">
          {% render 'product-features' product: product %}
        </div>

        {%- unless storefront == "INT" -%}
          <!-- Shop the look (Desktop) -->
          {% render 'product-shop-the-look' product: product, view: 'desktop' %}
        {%- endunless -%}
      </div>
      <div class="px-6 md:px-0 md:max-w-1/3 md:flex-1">
        {% render 'product-buy-box',
          product: product,
          quickview: quickview,
          discount_tag: discount_tag,
          limit_tag: limit_tag,
          storefront: storefront
        %}

        <!-- Feature Section (Mobile) -->
        <div class="block lg:hidden mt-7">
          {% render 'product-features' product: product %}
        </div>
      </div>
    </div>
  </div>

  {%- comment -%}
  {% if product.metafields["global"]["riding_conditions"] != blank %}
    <!-- Riding Conditions -->
    <div class="hidden md:block bg-sand">
      <div class="md:p-25 xl:pt-25 xl:px-22.5 xl:pb-33 mx-auto" style="max-width: 1380px;">
        {% include 'product-riding-conditions' load: product.metafields["global"]["riding_conditions"], subtitle: product.metafields["global"]["riding_conditions_subtitle"] %}
      </div>
    </div>
  {% endif %}
  {%- endcomment -%}

  <!-- Product Details -->
  <div class="lg:bg-faint-cloud">
    {%- render 'product-details' product: product -%}
    {%- render 'product-tech-specs' product: product -%}
  </div>

  <!-- Product Technology Accordions -->
  {%- section 'technology-sections' -%}

  <!-- Features & Technologies -->
  {% render 'product-technologies' product: product %}

  {%- unless storefront == "INT" -%}
    <!-- Shop the look (Mobile) -->
    {% render 'product-shop-the-look' product: product, view: 'mobile' %}
  {%- endunless -%}

  {% if storefront == 'CA' %}
    {%- render 'searchspring-recommendations' profile: 'customers-also-viewed' data: product storefront: storefront -%}
  {% else %}
    {% assign ss_recs_profiles = "shop-the-look,customers-also-viewed" %}
    {%- render 'searchspring-recommendations' profiles: ss_recs_profiles data: product storefront: storefront -%}
  {% endif %}

  {%- comment -%}
  <!-- PDP Related Products -->
  <div class="border-t-1 border-soft-grey md:border-none px-6 py-10 md:px-14 xl:px-22.5 xl:py-20 mx-auto overflow-x-hidden xl:overflow-x-visible" style="max-width: 1380px;">
    {% render 'product-related-products' %}
  </div>
  {%- endcomment -%}

  {% liquid
    if product.available
      assign current_variant = product.first_available_variant
    else
      assign current_variant = product.variants[0]
    endif
  %}

  <!-- PDP Yotpo Instagram Gallery -->
  {%- comment -%} TODO: Update Widget IDs for CA site {%- endcomment -%}
  {% assign ig_visible = product.metafields["global"]["ig_visible"] | downcase | strip %}
  {% if ig_visible == true or ig_visible == 'true' %}
    <div class="px-6 mb-16 md:p-25 xl:py-20 xl:px-22.5 mx-auto" style="max-width: 1380px;" data-pdp-ig>
      {% if product.metafields["global"]["ig_title"] != blank %}
        <h3 class="mb-1 uppercase">{{ product.metafields["global"]["ig_title"] }}</h3>
      {% endif %}
      {% if product.metafields["global"]["ig_subtitle"] != blank %}
        <p class="font-normal mb-4 md:mb-6 xl:mb-8">{{ product.metafields["global"]["ig_subtitle"] }}</p>
      {% endif %}
      <div
        class="yotpo yotpo-pictures-widget"
        data-gallery-id="{{- yotpo_widget_id -}}"
        data-product-id="{{ product.id }}">
      </div>
    </div>
  {% endif %}

  {%- unless storefront == "INT" -%}

  <!-- PDP Yotpo Reviews -->
  <div class="px-6 mb-16 md:p-25 md:pt-0 lg:mb-0 xl:px-22.5 xl:pb-0 mx-auto" style="max-width: 1380px;">
    {% render 'yotpo-main-widget' product: product, variant: current_variant %}
  </div>

  {%- endunless -%}

</div>
{%- if storefront == "US" -%}
  {% render 'truefit-script' %}
{%- endif -%}
{% render 'product-seo-schema' product: product %}