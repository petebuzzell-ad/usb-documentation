{%- comment -%}
Dearest future eHouse developer,

I want to apologize for the complexity that you will find as you peel back the layers of this project.

The requirements shifted beneath our feet, and we had to make compromises or quick decisions to adjust.
The client also had multiple competing priorities, some of which required us to make concessions or remove entire
pieces of functionality that were built for the launch.

Please don't hold this code against only me personally - it's the product of multiple failures.

I have some ideas in mind for refactoring this code, the most important of which is probably creating
an ES6 class to encompass the Buy Box. Currently, we are forced to update Buy Box code on the PDP and the Quickview separately.
In an ideal world, that would be one class which gets extended for the Quickview portion, so the logic/pricing/etc. can be managed in one place.

God speed, and good luck with all of this.

Sincerely,
Cam
{%- endcomment -%}

{% liquid
  if shop.permanent_domain == 'usbns.myshopify.com'
    assign storefront = "US"
  endif

  if customer
    assign discount_tag = false
    assign limit_tag = false
    for tag in customer.tags
      if tag contains "discount-"
        assign discount_tag = tag | remove: "discount-" | plus: 0
      endif
      if tag contains "limit-"
        assign limit_tag = tag | remove: "limit-" | plus: 0
      endif
    endfor
  endif

  assign is_pro = false
  if discount_tag and limit_tag
    assign is_pro = true
  endif
  assign storefront = "US"
%}

<div class="px-6 md:px-14 xl:px-22.5 max-w-[124.5rem] mx-auto my-4 md:my-8">
  {% render 'breadcrumbs' template: template, product: product %}
</div>
<div id="productTemplate" class="transition-opacity opacity-0"
  data-product-handle="{{ product.handle }}"
  data-product-type="onetime"
  {% if product.tags contains 'gift-for-good' %} data-gift-product="true" {% endif %}
>
  <h1 class="hidden">{{ product.title }}</h1>

  <!-- Above The Fold Container -->
  <div class="w-full md:px-14 xl:px-22.5 xl:mb-14 max-w-[124.5rem] mx-auto">
    <!-- Mobile Buy Box Info -->
    <div class="md:hidden">
      {% render 'product-buy-box-info', mobile: true, product: product, quickview: quickview, storefront: storefront %}
    </div>

    <!-- Gallery & Buy Box -->
    <div class="flex w-full flex-col md:flex-row md:gap-6">
      <div class="w-full md:w-2/3 md:max-w-product-gallery-desktop">
        {% comment %} CHECK from PI {% endcomment %}
        {% comment %} {% render 'product-gallery', product: product, quickview: quickview, storefront: storefront %} {% endcomment %}
        {% render 'product-gallery-new', product: product, quickview: quickview, storefront: storefront %}

        <!-- Feature Section (Desktop) -->
        <div class="hidden md:block md:pl-25">
          {% render 'product-features' product: product %}
        </div>

        <!-- Shop the look (Desktop) -->
        {% render 'product-shop-the-look' product: product, view: 'desktop' %}
      </div>
      <div class="px-6 md:px-0 md:max-w-1/3 md:flex-1">
        {% render 'product-buy-box',
          product: product,
          quickview: quickview,
          discount_tag: discount_tag,
          limit_tag: limit_tag,
          storefront: storefront
        %}

        <!-- Feature Section (Mobile) -->
        <div class="block lg:hidden mt-7">
          {% render 'product-features' product: product %}
        </div>

        <!-- Description Accordion -->
        {% comment %} <div class="mt-10 mb-14 lg:mt-8 lg:mb-0 lg:pl-16">
          {% include 'product-description' product: product %}
        </div> {% endcomment %}

      </div>
    </div>
  </div>

  <div class="w-full">
    <div
      class="yotpo yotpo-pictures-widget"
      data-gallery-id="68827b5f82ce99ba3f572836"
      data-product-id="{{ product.id }}">
    </div>
  </div>

  <!-- Product Details -->
  <div class="lg:bg-grey-seven">
    {%- render 'product-details' product: product -%}
    {%- render 'product-tech-specs' product: product -%}
  </div>

  <!-- Product Technology Accordions -->
  {%- section 'technology-sections' -%}

  <!-- Features & Technologies -->
  {% render 'product-technologies' product: product %}

  <!-- Shop the look (Mobile) -->
  {% render 'product-shop-the-look' product: product, view: 'mobile' %}

  {%- render 'searchspring-recommendations' profile: 'customers-also-viewed' data: product storefront: storefront -%}

  <!-- Reviews -->
  <div class="px-6 mb-16 md:p-25 md:pt-0 lg:mb-0 xl:px-22.5 xl:pb-0 mx-auto" style="max-width: 1380px;">
    {% render 'bv-ratings-reviews' %}
  </div>

  {% comment %} {% if product.metafields["global"]["riding_conditions"] != blank %}
    <!-- Riding Conditions -->
    <div class="hidden md:block bg-sand">
      <div class="md:p-25 lg:pt-25 lg:px-22.5 lg:pb-33 mx-auto" style="max-width: 1380px;">
        {% include 'product-riding-conditions' load: product.metafields["global"]["riding_conditions"], subtitle: product.metafields["global"]["riding_conditions_subtitle"] %}
      </div>
    </div>
  {% endif %} {% endcomment %}

  {%- comment -%}
  <!-- PDP Related Products -->
  <div class="border-t-1 border-soft-grey md:border-none px-6 py-10 md:px-14 lg:px-22.5 lg:py-20 mx-auto overflow-x-hidden xl:overflow-x-visible" style="max-width: 1380px;">
    {% render 'product-related-products' %}
  </div>
  {%- endcomment -%}

  {% liquid
    if product.available
      assign current_variant = product.first_available_variant
    else
      assign current_variant = product.variants[0]
    endif
  %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function checkAndHidePaymentTerms() {
    const productTemplate = document.querySelector('#productTemplate:has(delivery-promise-wc)');
    if (!productTemplate) return;

    const deliveryPromise = productTemplate.querySelector('delivery-promise-wc');
    if (!deliveryPromise) return;

    const genericPromise = deliveryPromise.querySelector('#generic-promise-wc');
    if (!genericPromise || !genericPromise.shadowRoot) return;

    const amazonPayBtn = genericPromise.shadowRoot.querySelector('button.amazon-pay-button');
    if (amazonPayBtn) {
      const paymentTerms = productTemplate.querySelector('shopify-payment-terms');
      if (paymentTerms) {
        paymentTerms.style.display = 'none';
        paymentTerms.parentElement.classList.remove('pb-3');
        paymentTerms.parentElement.classList.remove('border-b');
      }
    }
  }

  // Initial check
  checkAndHidePaymentTerms();

  // Observer for dynamic changes
  const observer = new MutationObserver(() => {
    checkAndHidePaymentTerms();
  });

  observer.observe(document.body, { childList: true, subtree: true });
});
  
</script>

{% render 'product-seo-schema' product: product %}